# 3 DevOps 流程 #

##**3.1 介绍**

谈到 DevOps ,出现在我们脑海里的是一群人在一起工作。但他们既缺少一个框架，也没有一个如 ITIL 那样的最佳实践模型。毕竟每个 DevOps 团队都是独一无二的，他们自己决定如何组织开展自己的工作。这个假设是正确的，但是同时关于这个假设还存在着很多争论。因为这群人所做的工作在本质上是重复性的，而且他们也是有着共同目标的。这也是为什么我们仍然可以在 DevOps 里谈论流程驱动方案。

流程由人员，资源和方法组成。尽管每个独立的 DevOps 团队的方案都是独一无二性的，但是从流程的角度来说却存在着固有的模式。事实上，法律和法规迫使流程里必须有着控制。这些法规和法规有着一般性，当然其控制也是可以被一般化的。

这篇文章描述了实践中 DevOps 流程的哪些方面构成了一些特定的模式。它也是接下来的一些文章的综合总述。接下来的文章分别从以下方面详细描述了 DevOps 流程：术语，概念，模式，经常问到的问题。

##**3.2 流程**

图3-1 图示了 DevOps 流程。它不是 DveOps 流程的规范定义。而是表述了在大多数组织机构中，为了实现一个服务而会被循环执行的阶段的逻辑集合。

蓝色箭头表示开发流程。橘色箭头表示运维流程。这两个流程构成了 DevOps 方案的方法核心。这篇文章不会触及资源，包括应用程序，基础架构和工具；也不会触及人员，包括功能，角色和文化。这两部分会在后续文章进行讨论。

运维和开发流程又可以再次被细分为一组阶段，程序或者甚至另外一组流程。它们都是由反复出现的步骤组成的。这些步骤都是为了达到同一个结果，实现同样的目的。

[https://github.com/xufeng2201/DevOps-Best-Practices-Xu-Feng](https://github.com/xufeng2201/DevOps-Best-Practices-Xu-Feng "Figure3-1_cn")
规划 编码 构建 测试 发布 部署 运维 监控

图3-1 一个 DevOps 流程（CollabNet）

把 DevOps 看作一个流程和发表一系列文章的出发点不是为了规范化 DevOps ，而是为了用一个比较结构化的方式来归类和交换故事以及最佳实践。当然我也深知 DevOps 规范化是不可能实现的。

另外，结构化的 DevOps 将会更加容易被定义，从而也更容易被解释。当然，我们需要意识到这些流程虽然是按照顺序画出来的，其实它还包含着一些反馈循环。例如，在测试流程中，为了解决缺陷，有可能触发编码流程。当然在 DevOps 中，从测试流程触发编码流程是一个浪费，应该尽可能避免。事实上，流程比图上标识的范围要宽泛一些，因此，监控流程也包括了监控整个 DevOps 流程。

最后，每个流程被列出来的产出物只包括了最重要的输出物，而不是所有的。接下来的文章会讨论 DevOps 最佳实践。这些文章并不是为了定义 DevOps ，而只是一系列的故事用来阐述这些流程是如何在实践中被应用实施的。

###**3.2.1 规划流程**

####**目的**

这个流程的目的是为了和干系人一起确定好以下内容：支持客户所需新服务的业务案例；交付服务的路线图和实现交付的最佳方案。

####**输出物**

- 指定的干系人 
- 确定的业务需求 
- 建立好的交付路线图 
- 选定的交付方案

####**解释**

干系人就是定义功能和非功能需求并买单的第三方。业务案例包括了给顾客产生的价值以及为此所需要的时间预算、财务预算以及风险控制成本。交付路线图是一个包含构建模块发布进程的季度时间表。每个构建模块都在史诗级别上定义。方案指的是采用何种开发流程，敏捷还是瀑布式。在实践中，大多数采用 DevOps 的组织的80%的业务案例都使用敏捷开发。在这个流程的结束部分，产品待办事项列表已经填好，DevOps 团队已经建立，预算也已经计算清楚。

循着这个最初计划，接下来就会有一个瀑布式开发项目或者 DevOps 方案。在 DevOps 方案中，服务将会采用循环方式增量交付。对每一个增量来说，都需要一个详细的计划，史诗被细化为特性，特性被细化为故事。这个方法经常在 Agile Scrum 开发和 Kanban 运营中使用。但是实践中任何组合可能都可以被接受。

###**3.2.2 编码流程**

####**目的**

 这个流程的目的是产生源代码文件以便生成构建流程所需要的应用程序和基础架构组建。 

####**输出物**

- 特性被细化为故事 
- 确定的功能或非功能需求的测量规则
- 定义好的验收测试课程
- 确定的技术需求
- 定义好的测试用例
- 源文件被保存在一个版本管理系统

####**解释**

源文件包含了开发人员编写的用来生成应用程序组件的源代码。然而，源文件还包括运维人员创建的用来配置基础架构组件的脚本。为了使之成为可能，我们使用所选定的特性。 特性就是使用业务语言描述的需要交付的功能或非功能需求。故事就是需要完成的源代码（应用程序）和脚本（基础构架）的技术描述。由于很多开发人员在一起编写代码，代码会随着时间而改变，因此保持源代码文件和脚本的唯一性来说非常重要。

###**3.2.3 构建流程**

####**目的**

构建流程的目的是将可应用的源代码转换成目标代码并执行一系列的单元测试。终极目标是在5分钟内验证源代码合格，并将其签入到基线中。

####**输出物**

- 创建目标代码，并且错误日志中没有错误记录
- 目标代码被存放在制品库中
- 源代码的质量已完成检查
- 单元测试执行完成，测试结果无任何错误
- 源代码签入到基线中

####**解释**

用一种适用于该问题域的编程语言编写源代码，例如 PHP 适用于网站 Web 开发，Java 代码用于业务功能开发。当用 PHP ， Basic 和 SQL 编程语言生成代码时，源代码可以直接用于生产，但是这通常需要把源代码转换成操作系统可读指令（目标代码）。这一过程产物称之为制品。如果源代码扫描和单元测试案例都是成功的，就把源代码签入到基线中。

单元测试不同于其他类型的测试，因为这些测试案例保留了目标代码的代码环境。鉴于5分钟构建的要求，因此不需要再对目标代码中需与其他应用组件或基础架构的协作进行测试检查。 DevOps 团队共享的源代码一起形成一个新的服务。

###**3.2.4 测试流程**

####**目的**

测试流程的目的是在当前冲刺中生成的所有源代码和基础架构脚本上执行集成测试和系统测试。

####**输出物**

- 系统和集成测试被成功执行
- 服务符合技术要求和度量要求规定
- 技术验收测试执行完成，测试结果无任何错误

####**解释**

集成测试定义为：测试应用程序组件间的协作。系统测试定义为：测试端到端的服务实现，包括对基础架构的测试。

###**3.2.5 发布流程**

####**目的**

发布流程的目的是判定服务的新版本是否满足其（非）功能要求。

####**输出物**

- 服务符合规定的（非）功能要求和度量要求
- 验收测试执行完成，测试结果无任何错误

####**解释**

在 DevOps 中，发布流程和部署流程有所区别。 发布过程是关于新版本服务的正确性的验证，而部署过程是为分发服务的新版本而服务的。 新版本服务的发布则是基于相关需求的测试结果。

###**3.2.6 部署流程**

####**目的**

部署流程的目的是通过部署流水线尽可能的实现以自动化的方式在生产环境推出新服务。

####**输出物**

- 基础架构脚本化的生产环境

####**解释**

自动化创建服务新版本是 DevOps 的一个重要方面，其实现机制就是部署流水线。实际上部署流水线并不只局限于部署过程。部署流水线从需求设定就已开始，自动化度量（编码过程），并最终自动化推出新服务和自动化安装补丁（运维过程），以保持服务永远满足需求。另外，重置旧版本服务也是部署流水线的功能的一部分。

###**3.2.7 运维流程**

####**目的**

运维流程的目的是保持服务的一直提升，并且运行符合约定的功能性（要求）和服务质量要求，保证持续的业务（价值）。

####**输出物**

- 安全的环境和数据；
- 执行管理任务
- 预防事件发生
- 持续观察事件

####**解释**

保持服务正常运行实际上是多个流程共同协作的结果，包括最底层的基础架构（基础架构管理）、应用程序（应用程序管理）和数据（信息管理）。为了使服务正常工作在编码过程需要采取多种措施。请注意，应对应用程序 bug 的解决方案并不是该过程的一部分，而是整个编码流程的一部分。

###**3.2.8 监控流程**

####**目的**

监控流程的目的是监控约定的服务标准是否符合标准。其范围不仅仅包括生产环境，而是涉及了整个 DevOps 流程。

####**输出物**

- 已建立的监控指南；
- 已定义的事项目录；
- 已装配的监控设施；
- 确定（潜在）的生产标准偏差；
- 已登记的事件
- 服务报告

####**解释**

监控服务正常运维实际是多个流程。包括底层的基础架构、应用程序和数据。为了使服务正常工作，我们需要在编码流程中采取多种措施。请注意，列入事件并不是监控过程的一部分，而是整个编码流程的一部分。

###**3.2.9  DevOps 框架结构关系**

图3-2给出了 DevOps 流程与 DevOps 框架间的关系概览，如下所示。

[https://github.com/xufeng2201/DevOps-Best-Practices-Xu-Feng](https://github.com/xufeng2201/DevOps-Best-Practices-Xu-Feng "Figure3-2_cn")
持续测试 敏捷开发 持续集成 持续交付 持续监控 敏捷过程 *图中白色字体文字翻译按自上而下，自左而右顺序*
规划 测试 编码 构建 发布 监控 运维 *图中蓝色字体文字翻译按自上而下，自左而右顺序*

图3-2_DevOps 流程与 DevOps 框架间的关系

如图所示，图中没有画出清晰的线条，但它向我们展示了其合理的连贯性。以下是对图2的简要解释，特别指明了这种关系不是纯粹的一对一的关系。

####**规划**

规划包含所有 DevOps 的活动，既包含最初的整个路线图又包含服务最后的增量交付。

####**编码**

敏捷开发主要涉及编码流程中命名的各个方面。

####**构建**

持续集成主要包括构建流程，也含有组件内部的测试。

####**测试**

持续测试在本文中比测试流程更多的被提到，因为它包括全生命周期中所有测试类型，如构建流程中的单元测试案例。

####**发布**

持续交付不仅是一次发布的推出，它还包括整个部署流水线。而这已经在敏捷开发可执行的测试案例中被定义。

####**运维**

这些敏捷流程实际包括所有 DevOps 的流程，而不仅仅是运维流程。整个 DevOps 流程是个敏捷流程。

####**监控**

持续监控不仅仅包括产品阶段，还包括整个 DevOps 流程。
 